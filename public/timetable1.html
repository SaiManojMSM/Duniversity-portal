<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Timetable | DSATM Student Portal</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* --- styles unchanged from your version --- */
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background-color: #f0faff;
      color: #003f5c;
    }
    .background {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background-image: url('images/img1.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -1;
    }
    header {
      background-color: #006994;
      color: white;
      padding: 30px 20px;
      text-align: center;
    }
    header h1 { margin: 0; font-size: 30px; }
    .menu-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 28px;
      background-color: #004f6e;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      z-index: 1000;
    }
    nav#nav-menu {
      position: absolute;
      top: 80px;
      right: 20px;
      background-color: #e0f4fa;
      display: none;
      flex-direction: column;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 999;
    }
    nav#nav-menu.show { display: flex; }
    nav#nav-menu a {
      text-decoration: none;
      color: #004f6e;
      padding: 10px 15px;
      background-color: #b3e0f2;
      margin: 5px 0;
      border-radius: 6px;
      font-weight: bold;
      text-align: center;
      transition: 0.3s;
    }
    nav#nav-menu a:hover {
      background-color: #80c8e8;
      transform: scale(1.05);
    }
    .container {
      max-width: 1100px;
      margin: 30px auto;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .controls { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 12px; }
    .controls .left, .controls .right { display:flex; gap: 10px; align-items:center; }
    select, button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-weight: 600;
      background: white;
      cursor: pointer;
    }
    button.primary { background-color: #006994; color: white; border: none; }
    button.warn { background-color: #d9534f; color: white; border: none; }
    .editor-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .editor-table th, .editor-table td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .editor-table th { background-color: #006994; color: white; }
    input.cell-input { width: 100%; padding: 6px 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #bbb; }
    .note { color: #004f6e; font-weight: 600; }
    footer { background-color: #003344; color: white; text-align: center; padding: 16px; font-size: 14px; margin-top: 30px; }
    .small { font-size: 13px; color: #333; }
  </style>
</head>
<body>

<div class="background"></div>

<header>
  <h1>📚 Admin Timetable Editor</h1>
  <div class="menu-toggle" id="menu-toggle">&#9776;</div>
</header>

<nav id="nav-menu">
  <a href="home1.html">Home</a>
  <a href="main.html">Login</a>
  <a href="timetable1.html">Timetable</a>
  <a href="exams1.html">Exam Editor</a>
  <a href="leavelogs.html">Leave Logs</a>
  <a href="grievance1.html">Grievance1</a>
</nav>

<div class="container">
  <div class="controls">
    <div class="left">
      <label class="small">Select Semester:</label>
      <select id="semesterSelect">
        <option value="sem1">Semester 1</option>
        <option value="sem2">Semester 2</option>
        <option value="sem3">Semester 3</option>
        <option value="sem4">Semester 4</option>
        <option value="sem5">Semester 5</option>
      </select>

      <label class="small">Branch:</label>
      <select id="branchSelect">
        <option value="">-- Choose branch --</option>
        <option value="CS">CS</option>
        <option value="Mechanical">Mechanical</option>
        <option value="CIVIL">CIVIL</option>
        <option value="AIML">AIML</option>
        <option value="DataScience">Data Science</option>
        <option value="EC">EC</option>
        <option value="EEE">EEE</option>
      </select>
    </div>

    <div class="right">
      <button id="loadPublished" class="small">Load Published</button>
      <button id="saveDraft" class="primary small">Save Draft</button>
      <button id="publish" class="primary small">Publish</button>
      <button id="clearDraft" class="warn small">Clear Draft</button>
    </div>
  </div>

  <div class="note">Edit cells and click <strong>Publish</strong> to make the timetable public for students </div>
  <div id="editorWrapper"></div>
</div>

<footer>
  &copy; 2025 DSATM Student Portal | All rights reserved.
</footer>

<script>
  function createEmptySkeleton() {
    const skeleton = {};
    ['sem1','sem2','sem3','sem4','sem5'].forEach(s => {
      skeleton[s] = [['Day','9–10 AM','10–11 AM','11–12 PM','12–1 PM','1–2 PM','2–3 PM']];
      ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(day => {
        skeleton[s].push([day,'','','','','','']);
      });
    });
    return skeleton;
  }

  function getCurrentBranch() {
    return document.getElementById('branchSelect').value;
  }

  function renderEditor(semId, timetableObj) {
    const wrapper = document.getElementById('editorWrapper');
    wrapper.innerHTML = '';

    const table = document.createElement('table');
    table.className = 'editor-table';

    const data = timetableObj?.[semId] 
      ? JSON.parse(JSON.stringify(timetableObj[semId])) 
      : createEmptySkeleton()[semId];

    data.forEach((rowArr, rIdx) => {
      const tr = document.createElement('tr');
      rowArr.forEach((cell, cIdx) => {
        if (rIdx === 0) {
          const th = document.createElement('th');
          th.textContent = cell || (cIdx === 0 ? 'Day' : `Slot ${cIdx}`);
          tr.appendChild(th);
        } else {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.className = 'cell-input';
          input.value = cell || '';
          td.appendChild(input);
          tr.appendChild(td);
        }
      });
      table.appendChild(tr);
    });

    wrapper.appendChild(table);
  }

  function collectEditorData() {
    const sem = document.getElementById('semesterSelect').value;
    const rows = Array.from(document.querySelector('.editor-table').rows);
    let timetable = {};
    timetable[sem] = rows.map((row, rIdx) => {
      return Array.from(row.cells).map((cell, cIdx) => {
        if (rIdx === 0) return cell.textContent.trim();
        const input = cell.querySelector('input');
        return input ? input.value : '';
      });
    });
    return timetable;
  }

  async function saveDraft() {
    alert("Drafts are no longer saved locally. Use Publish to store in database.");
  }

  async function publish() {
    const branch = getCurrentBranch();
    const sem = document.getElementById('semesterSelect').value;
    const timetableJson = collectEditorData();

    if (!branch) {
      alert("Please select a branch first.");
      return;
    }

    // Validate that we have actual timetable data
    if (!timetableJson[sem] || !Array.isArray(timetableJson[sem]) || timetableJson[sem].length < 2) {
      alert("Please enter timetable data before publishing.");
      return;
    }

    try {
      const res = await fetch('/save-timetable', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          branch: branch,
          semester: sem,
          timetable_json: timetableJson
        })
      });
      
      const data = await res.json();
      if (res.ok && data.success) {
        alert(`✅ Timetable published successfully for ${branch} - ${sem.toUpperCase()}!`);
      } else {
        alert('❌ Failed to publish: ' + (data.error || data.message || 'Unknown error'));
      }
    } catch (err) {
      console.error('Error publishing timetable:', err);
      alert('❌ Error publishing timetable. Please check your connection.');
    }
  }

  async function loadPublishedIntoEditor() {
    const branch = getCurrentBranch();
    const sem = document.getElementById('semesterSelect').value;

    if (!branch) {
      alert("Please select a branch first.");
      return;
    }

    try {
      const res = await fetch(`/get-timetable/${branch}/${sem}`);
      if (!res.ok) {
        if (res.status === 404) {
          throw new Error("No timetable found for this branch/semester");
        }
        throw new Error("Failed to load timetable");
      }
      const data = await res.json();
      
      // Check if we got valid data
      if (data && typeof data === 'object' && data[sem]) {
        renderEditor(sem, data);
        alert(`✅ Loaded existing timetable for ${branch} - ${sem.toUpperCase()}`);
      } else {
        throw new Error("No data found for this semester");
      }
    } catch (err) {
      console.error('Error loading published timetable:', err);
      alert(`❌ No published timetable found for ${branch} - ${sem.toUpperCase()}. Starting with empty template.`);
      renderEditor(sem, createEmptySkeleton());
    }
  }

  function clearDraft() {
    alert("Drafts are now managed in the database. No local draft to clear.");
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('semesterSelect').addEventListener('change', () => {
      renderEditor(document.getElementById('semesterSelect').value, createEmptySkeleton());
    });

    document.getElementById('branchSelect').addEventListener('change', (e) => {
      if (e.target.value && confirm('Load timetable for branch "' + e.target.value + '"?')) {
        loadPublishedIntoEditor();
      } else {
        e.target.value = '';
      }
    });

    document.getElementById('saveDraft').addEventListener('click', saveDraft);
    document.getElementById('publish').addEventListener('click', publish);
    document.getElementById('loadPublished').addEventListener('click', loadPublishedIntoEditor);
    document.getElementById('clearDraft').addEventListener('click', clearDraft);

    renderEditor(document.getElementById('semesterSelect').value, createEmptySkeleton());
  });
</script>

  <!-- Universal Menu Toggle Script -->
  <script src="menu-toggle.js"></script>

</body>
</html>

